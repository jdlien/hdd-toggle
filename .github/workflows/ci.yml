name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Visual Studio Dev Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build Tests
      run: |
        cl.exe /nologo /EHsc /std:c++17 /Zi /I include /Fe:tests\run-tests.exe tests\test_main.cpp tests\test_utils.cpp
      shell: cmd

    - name: Run Tests
      run: |
        tests\run-tests.exe --reporter junit --out test-results.xml
      shell: cmd

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results.xml

  build:
    runs-on: windows-latest
    needs: test
    strategy:
      matrix:
        include:
          - arch: x64
            msvc_arch: x64
            artifact_name: hdd-toggle-x64
            output_name: hdd-toggle.exe
          - arch: arm64
            msvc_arch: amd64_arm64
            artifact_name: hdd-toggle-arm64
            output_name: hdd-toggle-arm64.exe

    steps:
    - uses: actions/checkout@v4

    - name: Setup Visual Studio Dev Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.msvc_arch }}

    - name: Build Application (${{ matrix.arch }})
      run: |
        if not exist bin mkdir bin
        rc.exe /nologo /fo res\hdd-icon.res res\hdd-icon.rc
        cl.exe /nologo /O2 /MT /EHsc /std:c++17 /I include ^
          src\main.cpp ^
          src\core\process.cpp ^
          src\core\admin.cpp ^
          src\core\disk.cpp ^
          src\commands\relay.cpp ^
          src\commands\wake.cpp ^
          src\commands\sleep.cpp ^
          src\commands\status.cpp ^
          src\gui\tray-app.cpp ^
          /Fe:bin\${{ matrix.output_name }} ^
          res\hdd-icon.res ^
          shell32.lib advapi32.lib user32.lib comctl32.lib wbemuuid.lib ole32.lib oleaut32.lib setupapi.lib dwmapi.lib hid.lib WindowsApp.lib shlwapi.lib propsys.lib ^
          /link /SUBSYSTEM:WINDOWS
      shell: cmd

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: bin\${{ matrix.output_name }}
